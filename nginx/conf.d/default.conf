log_format extended '$remote_addr - $remote_user [$time_local] '
                    '"$request" $status $body_bytes_sent '
                    '"$http_referer" "$http_user_agent" '
                    'upstream=$upstream_addr upstream_status=$upstream_status '
                    'request_time=$request_time upstream_response_time=$upstream_response_time';

server {
    listen 80;
    server_name vskpip01.hdi.chile;

    # Logs
    access_log /var/log/nginx/copilot_access.log extended;
    error_log  /var/log/nginx/copilot_error.log debug;

    # Página estática raíz del servidor (no de la app)
    location / {
        root   /usr/share/nginx/html;
        index  index.html;
    }

    # ===========================================
    # VERSIÓN SIN OAUTH: /copilot-metrics-viewer/
    # ===========================================
    
    # Forzar slash final en el prefijo para evitar dobles requests
    location = /copilot-metrics-viewer {
        return 301 /copilot-metrics-viewer/;
    }

    # APP sin OAuth bajo prefijo: conservamos el prefijo (SIN slash al final en proxy_pass)
    location /copilot-metrics-viewer/ {
        proxy_pass http://copilot-metrics-viewer;
        proxy_http_version 1.1;

        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        proxy_connect_timeout 60s;
        proxy_send_timeout    60s;
        proxy_read_timeout    60s;

        proxy_intercept_errors on;
        proxy_redirect off;

        access_log /var/log/nginx/copilot_noauth_access.log extended;
        error_log  /var/log/nginx/copilot_noauth_error.log debug;
    }

    # APIs sin OAuth con prefijo -> strip a /api/... en el upstream
    location ~ ^/copilot-metrics-viewer/api/(.*)$ {
        proxy_pass http://copilot-metrics-viewer/api/$1;
        proxy_http_version 1.1;

        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        proxy_connect_timeout 60s;
        proxy_send_timeout    60s;
        proxy_read_timeout    60s;

        proxy_intercept_errors on;
        proxy_redirect off;

        access_log /var/log/nginx/copilot_noauth_access.log extended;
        error_log  /var/log/nginx/copilot_noauth_error.log debug;
    }

    # ===========================================
    # VERSIÓN CON OAUTH: /copilot-metrics-viewer-hdi/
    # ===========================================
    
    # Forzar slash final en el prefijo para evitar dobles requests
    location = /copilot-metrics-viewer-hdi {
        return 301 /copilot-metrics-viewer-hdi/;
    }

    # APP con OAuth bajo prefijo: conservamos el prefijo (SIN slash al final en proxy_pass)
    location /copilot-metrics-viewer-hdi/ {
        proxy_pass http://copilot-metrics-viewer-hdi;
        proxy_http_version 1.1;

        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        proxy_connect_timeout 60s;
        proxy_send_timeout    60s;
        proxy_read_timeout    60s;

        proxy_intercept_errors on;
        proxy_redirect off;

        access_log /var/log/nginx/copilot_oauth_access.log extended;
        error_log  /var/log/nginx/copilot_oauth_error.log debug;
    }

    # APIs con OAuth con prefijo -> strip a /api/... en el upstream (evita 404 y bucles 302)
    location ~ ^/copilot-metrics-viewer-hdi/api/(.*)$ {
        proxy_pass http://copilot-metrics-viewer-hdi/api/$1;
        proxy_http_version 1.1;

        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        proxy_connect_timeout 60s;
        proxy_send_timeout    60s;
        proxy_read_timeout    60s;

        proxy_intercept_errors on;
        proxy_redirect off;

        access_log /var/log/nginx/copilot_oauth_access.log extended;
        error_log  /var/log/nginx/copilot_oauth_error.log debug;
    }

    # AUTH con OAuth con prefijo -> strip a /auth/... en el upstream (corrige callback /auth/github)
    location ~ ^/copilot-metrics-viewer-hdi/auth/(.*)$ {
        proxy_pass http://copilot-metrics-viewer-hdi/auth/$1;
        proxy_http_version 1.1;

        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        proxy_connect_timeout 60s;
        proxy_send_timeout    60s;
        proxy_read_timeout    60s;

        proxy_intercept_errors on;
        proxy_redirect off;

        access_log /var/log/nginx/copilot_oauth_access.log extended;
        error_log  /var/log/nginx/copilot_oauth_error.log debug;
    }

    # Favicon del servidor
    location = /favicon.ico {
        log_not_found off;
        access_log off;
        return 204;
    }
}
